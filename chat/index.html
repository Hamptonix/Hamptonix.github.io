<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Live Chat — Firestore</title>
<style>
:root{
  --bg:#0b0b0b;
  --panel:#0f1720;
  --muted:#9aa4b2;
  --accent:#10a37f;
  --button-bg:#0ea5a1;
  --button-text:#001018;
  --msg-bg: rgba(255,255,255,0.02);
}
html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui;}
body{background:var(--bg); color:#e6eef6; display:flex; align-items:stretch;}
.app{display:flex;width:100%;max-width:1200px;margin:auto;box-shadow:0 10px 30px rgba(0,0,0,0.6);border-radius:10px;overflow:hidden;}
.sidebar{width:320px;background:var(--panel);padding:18px;box-sizing:border-box;}
.sidebar h3{margin:6px 0 8px;font-size:14px;}
label{display:block;font-size:12px;color:var(--muted);margin-top:10px;}
input[type="text"]{width:100%; padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit;}
input[type="color"]{width:56px;height:36px;border-radius:6px;border:none;padding:0;margin-left:6px;vertical-align:middle;}
.small{font-size:12px;color:var(--muted);}
.online-pill{font-size:13px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.04);color:var(--muted);}
.clear-btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:8px;color:var(--muted);cursor:pointer;}
.main{flex:1;display:flex;flex-direction:column;background:var(--bg);min-height:60vh;}
.header{padding:16px 18px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.03);}
.title{font-weight:700;letter-spacing:0.2px;}
.messages{padding:18px;flex:1;overflow:auto;display:flex;flex-direction:column;gap:12px;}
.message{background:var(--msg-bg);padding:10px 12px;border-radius:8px;width:fit-content;max-width:78%;box-shadow:inset 0 0 0 1px rgba(255,255,255,0.01);}
.username{font-weight:700;font-size:13px;margin-bottom:4px;}
.text{font-size:13px;color:#dce9f2;line-height:1.25;white-space:pre-wrap;}
.meta{font-size:11px;color:var(--muted);margin-top:6px;display:flex;gap:8px;align-items:center;}
.timer{font-size:11px;color:var(--muted);}
.composer{border-top:1px solid rgba(255,255,255,0.03);padding:12px;display:flex;gap:10px;align-items:center;}
.composer textarea{flex:1;min-height:48px;max-height:120px;resize:none;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;}
.send-btn{padding:10px 14px;border-radius:8px;background:var(--button-bg);color:var(--button-text);border:none;cursor:pointer;font-weight:700;box-shadow:0 6px 20px rgba(14,165,161,0.12);}
.messages, .message{align-items:flex-start;text-align:left;}
</style>
</head>
<body>
<div class="app">
  <div class="sidebar">
    <h3>Profile</h3>
    <label>Username</label>
    <input id="usernameInput" type="text" maxlength="40" placeholder="Pick a name (default: Guest)" />
    <label>Username color <span class="small">(default white)</span></label>
    <div style="display:flex;align-items:center">
      <input id="colorPicker" type="color" value="#ffffff" />
      <div style="margin-left:12px" class="small">Preview: <span id="previewName" style="font-weight:700">Guest</span></div>
    </div>
    <label style="margin-top:16px">Online</label>
    <div style="display:flex;align-items:center;gap:8px;margin-top:6px">
      <div class="online-pill" id="onlineCount">0 online</div>
    </div>
    <div style="margin-top:18px">
      <button id="clearLocal" class="clear-btn">Reset username</button>
    </div>
  </div>
  <div class="main">
    <div class="header">
      <div class="title">Live Chat</div>
      <div class="online-pill" id="onlineTop">0 online</div>
    </div>
    <div class="messages" id="messages"></div>
    <div class="composer">
      <textarea id="msgInput" placeholder="Type a message..." maxlength="2000"></textarea>
      <button id="sendBtn" class="send-btn">Send</button>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  /* FIREBASE CONFIG HERE */
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- UI refs ---
const usernameInput = document.getElementById('usernameInput');
const colorPicker = document.getElementById('colorPicker');
const previewName = document.getElementById('previewName');
const onlineCount = document.getElementById('onlineCount');
const onlineTop = document.getElementById('onlineTop');
const messagesDiv = document.getElementById('messages');
const msgInput = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');
const clearLocal = document.getElementById('clearLocal');

// --- Local username & color ---
const LOCAL_KEY = 'livechat_user';
let saved = JSON.parse(localStorage.getItem(LOCAL_KEY) || '{}');
if (saved.name) usernameInput.value = saved.name;
if (saved.color) colorPicker.value = saved.color;
updatePreview();
function updatePreview(){
  const name = usernameInput.value || 'Guest';
  previewName.innerText = name;
  previewName.style.color = colorPicker.value;
  localStorage.setItem(LOCAL_KEY, JSON.stringify({ name: usernameInput.value, color: colorPicker.value }));
}
usernameInput.addEventListener('input', updatePreview);
colorPicker.addEventListener('input', updatePreview);
clearLocal.addEventListener('click', ()=>{
  localStorage.removeItem(LOCAL_KEY);
  usernameInput.value = '';
  colorPicker.value = '#ffffff';
  updatePreview();
});

// --- Messaging ---
const MESSAGES_COL = 'messages';
const messagesCollection = collection(db, MESSAGES_COL);
const messagesQuery = query(messagesCollection, orderBy('createdAt', 'asc'));
const msgTimers = new Map();
function formatRemaining(ms){
  if (ms <= 0) return '0s';
  const s = Math.floor(ms/1000);
  if (s < 60) return `${s}s`;
  if (s < 3600) return `${Math.floor(s/60)}m ${s%60}s`;
  return `${Math.floor(s/3600)}h ${Math.floor((s%3600)/60)}m`;
}
onSnapshot(messagesQuery, (snapshot)=>{
  messagesDiv.innerHTML = '';
  const now = Date.now();
  snapshot.forEach(docSnap=>{
    const data = docSnap.data();
    const id = docSnap.id;
    const createdAt = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate().getTime() : Date.now();
    const expireAt = data.expireAt && data.expireAt.toDate ? data.expireAt.toDate().getTime() : createdAt + 3600_000;
    if (Date.now() >= expireAt){ deleteDoc(doc(db,MESSAGES_COL,id)).catch(()=>{}); return; }

    const wrap = document.createElement('div'); wrap.className='message';
    const usernameEl = document.createElement('div'); usernameEl.className='username'; usernameEl.innerText=data.username||'Guest'; usernameEl.style.color=data.usernameColor||'#fff';
    const textEl = document.createElement('div'); textEl.className='text'; textEl.innerText=data.text||'';
    const meta = document.createElement('div'); meta.className='meta';
    const createdRel = document.createElement('div'); createdRel.className='small'; createdRel.innerText = new Date(createdAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    const timer = document.createElement('div'); timer.className='timer'; timer.innerText='Deleting in '+formatRemaining(expireAt-Date.now());
    meta.appendChild(createdRel); meta.appendChild(timer);
    wrap.appendChild(usernameEl); wrap.appendChild(textEl); wrap.appendChild(meta);
    messagesDiv.appendChild(wrap); messagesDiv.scrollTop = messagesDiv.scrollHeight;

    if (msgTimers.has(id)) clearInterval(msgTimers.get(id));
    const interval = setInterval(async()=>{
      const remaining = expireAt - Date.now();
      if (remaining <=0){
        timer.innerText='Deleting…';
        clearInterval(interval); msgTimers.delete(id);
        try{ await deleteDoc(doc(db,MESSAGES_COL,id)); }catch{}
        if(wrap.parentNode) wrap.parentNode.removeChild(wrap);
        return;
      } else { timer.innerText='Deleting in '+formatRemaining(remaining); }
    },1000);
    msgTimers.set(id,interval);
  });
});

sendBtn.addEventListener('click', sendMessage);
msgInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendMessage(); }});
async function sendMessage(){
  const text=msgInput.value.trim(); if(!text) return;
  const name = usernameInput.value.trim() || 'Guest';
  const color = colorPicker.value || '#ffffff';
  msgInput.value=''; msgInput.focus();
  try { await addDoc(messagesCollection, { username:name, usernameColor:color, text:text, createdAt:serverTimestamp(), expireAt:new Date(Date.now()+3600_000) }); } 
  catch(e){ console.error('send failed', e); alert('Failed to send message'); }
}
</script>
</body>
</html>
