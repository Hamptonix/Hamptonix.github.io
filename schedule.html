<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hamptonix | Schedule</title>
  <link rel="icon" type="image/png" href="https://i.postimg.cc/HnDd4JkX/channels4-profile-removebg-preview.png" />
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/style.css"/>

  <style>
    /* full theme & layout (kept & extended from your previous file) */
    :root{
      --accent: rgba(48,64,242,1);
      --glow: rgba(48,64,242,0.35);
      --muted: #9aa4b2;
    }
    html,body{height:100%;margin:0;font-family:Poppins,Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;}
    #navbar-container{position:relative;z-index:50;}
    .schedule-app{
      display:flex;justify-content:center;align-items:flex-start;min-height:100vh;
      background:linear-gradient(180deg,#020204 0%,#091014 100%);
      padding:30px 20px;box-sizing:border-box;color:#e6eef6;
    }
    .card{
      width:100%;max-width:900px;background:rgba(15,23,32,0.6);backdrop-filter:blur(14px);
      border-radius:16px;padding:20px;border:1px solid rgba(255,255,255,0.06);box-shadow:0 10px 40px rgba(0,0,0,0.6);
    }
    .header-row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0 0 8px 0;font-size:1.6rem}
    .controls{display:flex;gap:10px;align-items:center}
    select,input[type="text"]{
      padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.03);color:#fff;font-size:0.95rem;
    }
    .btn{padding:10px 14px;border-radius:12px;border:none;cursor:pointer;font-weight:600;background:linear-gradient(90deg,var(--accent),rgba(80,100,255,0.9));color:#fff;box-shadow:0 6px 18px var(--glow)}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.08);box-shadow:none;color:#e6eef6}
    .timers{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .timer{font-size:0.95rem;font-weight:600;background:rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;min-width:140px;text-align:center}
    .progress-wrapper{margin-top:10px;background:rgba(255,255,255,0.08);border-radius:12px;overflow:hidden;height:14px;box-shadow:inset 0 2px 6px rgba(0,0,0,0.6)}
    .progress-bar{height:100%;width:0%;background:var(--accent);box-shadow:0 0 12px var(--glow);transition:width 0.5s ease}
    /* Search container below timers */
    .search-container{margin-top:18px;background:rgba(255,255,255,0.02);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .search-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .result-list{margin-top:10px;display:flex;flex-direction:column;gap:8px}
    .result-item{background:rgba(255,255,255,0.02);border-radius:10px;padding:8px;border:1px solid rgba(255,255,255,0.03)}
    .result-header{display:flex;justify-content:space-between;align-items:center;cursor:pointer}
    .result-header .name{font-weight:700;color:#fff}
    .result-header .meta{color:var(--muted);font-size:0.95rem}
    .result-body{margin-top:8px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.03);display:none}
    .period{display:flex;justify-content:space-between;padding:6px 4px}
    .highlight{background:linear-gradient(90deg, rgba(48,64,242,0.08), rgba(48,64,242,0.04));border:1px solid rgba(48,64,242,0.12);border-radius:8px;padding:6px}
    .small{font-size:0.9rem;color:var(--muted)}
    .right-actions{display:flex;gap:8px;align-items:center}
    .inline-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px 8px;border-radius:8px;color:#fff;cursor:pointer}
    .inline-btn.ghost{color:var(--muted)}
    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:linear-gradient(180deg,rgba(1,2,3,0.6),rgba(1,2,3,0.85));display:none;align-items:center;justify-content:center;z-index:4000}
    .modal{width:100%;max-width:640px;background:rgba(12,16,24,0.98);border-radius:14px;padding:18px;border:1px solid rgba(255,255,255,0.06)}
    .modal h3{margin:0 0 8px;color:var(--accent)}
    .form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .form-grid .full{grid-column:1/-1}
    @media (max-width:720px){
      .form-grid{grid-template-columns:1fr}
      .timers{justify-content:stretch}
    }
  </style>
</head>
<body>
  <div id="navbar-container"></div>

  <div class="schedule-app">
    <div class="card">
      <div class="header-row">
        <div>
          <h1>Odyssey Schedule Tracker</h1>
          <div class="small">Select lunch to update the timer & schedule view</div>
        </div>
        <div class="controls">
          <label for="lunch" class="small" style="margin-right:8px; align-self:center;">Lunch:</label>
          <select id="lunch">
            <option value="1">Lunch 1</option>
            <option value="2">Lunch 2</option>
          </select>
          <button id="openAddBtn" class="btn" title="Add / edit your schedule">Add / Edit Your Schedule</button>
        </div>
      </div>

      <div style="margin-top:10px">
        <h2 id="currentPeriod">Loading...</h2>
        <div class="progress-wrapper"><div id="progressBar" class="progress-bar"></div></div>

        <div class="timers">
          <div class="timer" id="elapsed">Elapsed: --</div>
          <div class="timer" id="remaining">Remaining: --</div>
          <div class="timer" id="endOfDay">Until End of Day: --</div>
          <div class="timer" id="weekendTimer">Until Weekend: --</div>
        </div>
      </div>

      <!-- SEARCH CONTAINER (below timers) -->
      <div class="search-container" id="searchContainer">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <div style="flex:1">
            <input id="searchInput" type="text" placeholder="Search name..." style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff" />
          </div>
          <div style="display:flex;gap:8px">
            <button id="searchBtn" class="btn ghost">Search</button>
            <button id="clearSearch" class="inline-btn ghost">Clear</button>
          </div>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <div class="small">Results: <span id="resultsCount">0</span></div>
          <div class="small">Tip: type a first or last name (prefix search)</div>
        </div>

        <div class="result-list" id="resultList" style="margin-top:10px"></div>
      </div>

      <!-- user schedule box (hidden by default when not used) -->
      <div id="userScheduleBox" class="user-schedule" style="display:none;margin-top:12px"></div>

    </div>
  </div>

  <!-- Modal -->
  <div id="addModal" class="modal-backdrop">
    <div class="modal">
      <h3>Add / Edit Your Schedule</h3>
      <div style="margin-bottom:10px" class="small">You must be logged in to save. Logged in as: <strong id="loggedEmail">Not logged in</strong></div>

      <div style="margin-bottom:10px">
        <label style="display:block;margin-bottom:6px">Display name (shown in search results)</label>
        <input id="modalName" type="text" placeholder="e.g. Eli Hampton" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff">
      </div>

      <div style="margin-bottom:10px">
        <label style="display:block;margin-bottom:6px">Lunch</label>
        <select id="modalLunch" style="width:100%;padding:10px;border-radius:8px">
          <option value="1">1st Lunch</option>
          <option value="2">2nd Lunch</option>
        </select>
      </div>

      <div id="periodInputs" style="margin-bottom:8px"></div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button id="cancelModal" class="btn ghost">Cancel</button>
        <button id="saveSchedule" class="btn">Save Schedule</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
  /***************
   * SCHEDULE + TIMER LOGIC (full from your previous script)
   ***************/
  // Base schedules (without passing periods)
  const schedulesBase = {
    1: [
      {name:"Period 1", start:"07:40", end:"08:45"},
      {name:"Period 2", start:"08:47", end:"09:52"},
      {name:"Period 3", start:"09:54", end:"10:59"},
      {name:"LUNCH",    start:"11:01", end:"11:21"},
      {name:"Period 5", start:"11:23", end:"12:28"},
      {name:"Period 6", start:"12:30", end:"13:35"},
      {name:"Period 7", start:"13:37", end:"14:42"},
      {name:"Period 8", start:"14:44", end:"15:49"},
    ],
    2: [
      {name:"Period 1", start:"07:40", end:"08:45"},
      {name:"Period 2", start:"08:47", end:"09:52"},
      {name:"Period 3", start:"09:54", end:"10:59"},
      {name:"Period 4", start:"11:01", end:"12:06"},
      {name:"LUNCH",    start:"12:08", end:"12:28"},
      {name:"Period 6", start:"12:30", end:"13:35"},
      {name:"Period 7", start:"13:37", end:"14:42"},
      {name:"Period 8", start:"14:44", end:"15:49"},
    ]
  };

  function parseTime(timeStr) {
    const [h,m] = timeStr.split(":").map(Number);
    const d = new Date();
    d.setHours(h, m, 0, 0);
    return d;
  }
  function addMinutes(timeStr, mins) {
    const d = parseTime(timeStr);
    d.setMinutes(d.getMinutes() + mins);
    return d.toTimeString().slice(0,5);
  }
  function withPassingPeriods(schedule) {
    const result = [];
    for (let i = 0; i < schedule.length; i++) {
      result.push(schedule[i]);
      if (i < schedule.length - 1) {
        result.push({
          name: "Passing Period",
          start: schedule[i].end,
          end: addMinutes(schedule[i].end, 2)
        });
      }
    }
    return result;
  }
  const schedules = {
    1: withPassingPeriods(schedulesBase[1]),
    2: withPassingPeriods(schedulesBase[2])
  };

  function formatDuration(ms) {
    if (ms < 0) ms = 0;
    const totalSeconds = Math.floor(ms / 1000);
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = totalSeconds % 60;
    return `${h}h ${m}m ${s}s`;
  }

  function nextWeekendStart(now) {
    const d = new Date(now);
    const day = d.getDay();
    const daysUntilFriday = (5 - day + 7) % 7;
    d.setDate(d.getDate() + daysUntilFriday);
    d.setHours(0,0,0,0);
    return d;
  }
  function nextSchoolStart(now) {
    const d = new Date(now);
    let day = d.getDay();
    let addDays = 0;
    if (day === 5) addDays = 3;
    else if (day === 6) addDays = 2;
    else if (day === 0) addDays = 1;
    else addDays = 1;
    d.setDate(d.getDate()+addDays);
    d.setHours(7,40,0,0);
    return d;
  }

  // Update timers / progress — uses chosen lunch select
  function updateSchedule() {
    const lunchChoice = document.getElementById("lunch").value;
    const now = new Date();
    const day = now.getDay(); // 0=Sun, 1=Mon
    const display = document.getElementById("currentPeriod");
    const elapsedEl = document.getElementById("elapsed");
    const remainingEl = document.getElementById("remaining");
    const progressBar = document.getElementById("progressBar");
    const endOfDayEl = document.getElementById("endOfDay");
    const weekendEl = document.getElementById("weekendTimer");

    // Weekend handling
    if (day === 5 || day === 6 || day === 0) {
      display.textContent = "It's the weekend 🎉";
      elapsedEl.textContent = "Elapsed: --";
      remainingEl.textContent = "Remaining: --";
      progressBar.style.width = "0%";
      endOfDayEl.textContent = "Until School Starts: " + formatDuration(nextSchoolStart(now) - now);
      weekendEl.textContent = "Weekend: NOW";
      return;
    }

    const todaysSchedule = schedules[lunchChoice];
    let current = null;
    for (const p of todaysSchedule) {
      const start = parseTime(p.start);
      const end = parseTime(p.end);
      if (now >= start && now <= end) {
        current = { ...p, start, end };
        break;
      }
    }

    if (current) {
      display.textContent = `Current: ${current.name}`;
      const elapsedMs = now - current.start;
      const remainingMs = current.end - now;
      const totalMs = current.end - current.start;
      elapsedEl.textContent = `Elapsed: ${formatDuration(elapsedMs)}`;
      remainingEl.textContent = `Remaining: ${formatDuration(remainingMs)}`;
      progressBar.style.width = `${Math.max(0, Math.min(100, (elapsedMs/totalMs)*100))}%`;
    } else {
      display.textContent = "No class in session";
      elapsedEl.textContent = "Elapsed: --";
      remainingEl.textContent = "Remaining: --";
      progressBar.style.width = "0%";
    }

    // End of day timer
    const lastEnd = parseTime(todaysSchedule[todaysSchedule.length-1].end);
    if (now < lastEnd) {
      endOfDayEl.textContent = "Until End of Day: " + formatDuration(lastEnd - now);
    } else {
      endOfDayEl.textContent = "Until School Starts: " + formatDuration(nextSchoolStart(now) - now);
    }

    // Weekend timer
    const weekendStart = nextWeekendStart(now);
    if (now >= weekendStart) {
      weekendEl.textContent = "Weekend: NOW";
    } else {
      weekendEl.textContent = "Until Weekend: " + formatDuration(weekendStart - now);
    }
  }

  setInterval(updateSchedule, 1000);
  updateSchedule();

  /***************
   * FIREBASE: two apps (navApp stays for navbar/auth; scheduleApp for schedule data)
   ***************/
  // NAVBAR Firebase (original project used by your navbar)
  const navConfig = {
    apiKey: "AIzaSyCxscgTATE4IUgB7pGX01lP3Wr8pdU1B_8",
    authDomain: "hamptonixwebsite-dea39.firebaseapp.com",
    projectId: "hamptonixwebsite-dea39",
    storageBucket: "hamptonixwebsite-dea39.appspot.com",
    messagingSenderId: "847673046697",
    appId: "1:847673046697:web:99d1de90522f1545cd5bb8",
    measurementId: "G-CBL1NL69PH",
  };
  const navApp = firebase.initializeApp(navConfig, "navApp");
  const navAuth = navApp.auth();
  const navDb = navApp.firestore();

  // SCHEDULE Firebase (NEW project provided by you)
  const scheduleConfig = {
    apiKey: "AIzaSyC5fRmcLfedV0C_KQI7xgiLxe9QSFJ9Nqg",
    authDomain: "school-schedule-tracker-dd433.firebaseapp.com",
    projectId: "school-schedule-tracker-dd433",
    storageBucket: "school-schedule-tracker-dd433.firebasestorage.app",
    messagingSenderId: "424273851516",
    appId: "1:424273851516:web:fcd136728acaee29a0c5f9",
    measurementId: "G-36S4Q1GB3G"
  };
  const scheduleApp = firebase.initializeApp(scheduleConfig, "scheduleApp");
  const scheduleDb = scheduleApp.firestore();

  /***************
   * UI ELEMENTS & HELPERS
   ***************/
  const openAddBtn = document.getElementById('openAddBtn');
  const addModal = document.getElementById('addModal');
  const cancelModal = document.getElementById('cancelModal');
  const saveScheduleBtn = document.getElementById('saveSchedule');
  const modalName = document.getElementById('modalName');
  const modalLunch = document.getElementById('modalLunch');
  const periodInputs = document.getElementById('periodInputs');
  const loggedEmailEl = document.getElementById('loggedEmail');

  const searchInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('searchBtn');
  const clearSearch = document.getElementById('clearSearch');
  const resultList = document.getElementById('resultList');
  const resultsCount = document.getElementById('resultsCount');

  const userScheduleBox = document.getElementById('userScheduleBox');

  // Given lunch choice, return array of period labels user must fill
  function getInputPeriodsForLunch(lunch) {
    if (lunch === '1') return ["Period 1","Period 2","Period 3","Period 5","Period 6","Period 7","Period 8"];
    return ["Period 1","Period 2","Period 3","Period 4","Period 6","Period 7","Period 8"];
  }

  function renderPeriodInputs(lunch, classesObj = {}) {
    const periods = getInputPeriodsForLunch(String(lunch));
    periodInputs.innerHTML = '';
    const info = document.createElement('div');
    info.className = 'small';
    info.style.marginBottom = '8px';
    info.textContent = `Fill the 7 class boxes that match ${lunch === '1' ? '1st Lunch' : '2nd Lunch'}.`;
    periodInputs.appendChild(info);

    const grid = document.createElement('div');
    grid.className = 'form-grid';
    for (let i=0;i<periods.length;i++){
      const name = periods[i];
      const wrapper = document.createElement('div');
      wrapper.className = (i===0 && periods.length===7)?'full':'';
      const label = document.createElement('label');
      label.textContent = name;
      label.style.display = 'block';
      label.style.color = 'var(--muted)';
      label.style.marginBottom = '6px';
      const input = document.createElement('input');
      input.type = 'text';
      input.value = classesObj[name] ?? '';
      input.placeholder = `Enter class for ${name}`;
      input.dataset.period = name;
      input.style.width = '100%';
      input.style.padding = '8px';
      input.style.borderRadius = '8px';
      input.style.border = '1px solid rgba(255,255,255,0.06)';
      input.style.background = 'transparent';
      input.style.color = '#fff';
      wrapper.appendChild(label);
      wrapper.appendChild(input);
      grid.appendChild(wrapper);
    }
    periodInputs.appendChild(grid);
  }

  // Open modal (requires login)
  openAddBtn.addEventListener('click', async () => {
    const user = navAuth.currentUser;
    if (!user) { alert('You must be logged in to add or edit your schedule.'); return; }
    loggedEmailEl.textContent = user.email || 'Unknown';
    // prefill with existing schedule if exists
    try {
      const docRef = scheduleDb.collection('schedules').doc(user.uid);
      const doc = await docRef.get();
      if (doc.exists) {
        const data = doc.data();
        modalName.value = data.displayName ?? user.displayName ?? user.email.split('@')[0];
        modalLunch.value = data.lunch ?? '1';
        renderPeriodInputs(modalLunch.value, data.classes || {});
      } else {
        modalName.value = user.displayName ?? user.email.split('@')[0];
        modalLunch.value = document.getElementById('lunch').value || '1';
        renderPeriodInputs(modalLunch.value, {});
      }
      addModal.style.display = 'flex';
    } catch (err) {
      console.error('Failed to prefill modal', err);
      // still show modal but clean
      modalName.value = user.displayName ?? user.email.split('@')[0];
      modalLunch.value = document.getElementById('lunch').value || '1';
      renderPeriodInputs(modalLunch.value, {});
      addModal.style.display = 'flex';
    }
  });

  cancelModal.addEventListener('click', ()=> addModal.style.display='none');
  modalLunch.addEventListener('change', ()=> renderPeriodInputs(modalLunch.value));

  // Client-side validation and save
  saveScheduleBtn.addEventListener('click', async () => {
    const user = navAuth.currentUser;
    if (!user) { alert('You must be logged in to save your schedule.'); return; }

    const name = modalName.value.trim();
    if (name.length < 2) { alert('Please provide a display name (2+ characters).'); return; }

    const lunch = modalLunch.value;
    const inputs = periodInputs.querySelectorAll('input[data-period]');
    const classes = {};
    let allFilled = true;
    inputs.forEach(inp => {
      const val = inp.value.trim();
      classes[inp.dataset.period] = val || '(No class)';
      if (!val) allFilled = false;
    });

    // Validate at least all class boxes not empty (user requested validation). If you prefer allow blank -> you can change
    if (!allFilled) {
      if (!confirm('Some class boxes are empty. Save anyway?')) return;
    }

    const docId = user.uid; // store by uid so only owner can update (and later secure with rules)
    const scheduleObj = {
      uid: user.uid,
      displayName: name,
      displayNameLower: name.toLowerCase(),
      lunch,
      classes,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    console.log('Attempting to save schedule:', scheduleObj);

    try {
      await scheduleDb.collection('schedules').doc(docId).set(scheduleObj);
      addModal.style.display = 'none';
      // refresh search results if any
      if (searchInput.value.trim()) doSearch();
      // show a small confirmation & update my schedule box
      alert('Schedule saved!');
      if (user) loadMySchedule();
    } catch (e) {
      console.error('Save failed', e);
      alert('Failed to save schedule: ' + (e.message || e));
    }
  });

  /***************
   * SEARCH: indexed prefix search on displayNameLower + client-side filtering & collapsible results
   ***************/
  let searchDebounceTimer = null;
  function debounceSearch() {
    if (searchDebounceTimer) clearTimeout(searchDebounceTimer);
    searchDebounceTimer = setTimeout(() => doSearch(), 250);
  }

  async function doSearch() {
    const qRaw = searchInput.value.trim();
    const q = qRaw.toLowerCase();
    resultList.innerHTML = '';
    resultsCount.textContent = '0';
    if (!q) return;

    try {
      const end = q + '\uf8ff';
      // Query the schedules collection using indexed field displayNameLower
      const snapshot = await scheduleDb.collection('schedules')
        .where('displayNameLower', '>=', q)
        .where('displayNameLower', '<=', end)
        .limit(40)
        .get();

      const docs = [];
      snapshot.forEach(doc => docs.push({ id: doc.id, ...doc.data() }));

      // Client-side tiny filter to ensure includes q (helps with names containing word in middle)
      const filtered = docs.filter(d => d.displayNameLower && d.displayNameLower.includes(q));
      resultsCount.textContent = filtered.length;

      if (filtered.length === 0) {
        resultList.innerHTML = `<div class="small" style="padding:8px;color:var(--muted)">No matches</div>`;
        return;
      }

      filtered.forEach(doc => {
        // Create result item
        const item = document.createElement('div');
        item.className = 'result-item';
        // header: name, lunch, actions
        const header = document.createElement('div');
        header.className = 'result-header';
        const left = document.createElement('div');
        left.innerHTML = `<div class="name">${escapeHtml(doc.displayName)}</div><div class="meta small">${doc.lunch === '1' ? '1st Lunch' : '2nd Lunch'}</div>`;
        const right = document.createElement('div');
        right.className = 'right-actions';

        // Edit button visible only if logged-in user is owner
        const currentUser = navAuth.currentUser;
        if (currentUser && currentUser.uid === doc.id) {
          const editBtn = document.createElement('button');
          editBtn.className = 'inline-btn';
          editBtn.textContent = 'Edit';
          editBtn.addEventListener('click', (ev) => {
            ev.stopPropagation();
            openEditorForDoc(doc);
          });
          right.appendChild(editBtn);
        }

        // Collapse toggle icon
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'inline-btn ghost';
        toggleBtn.textContent = 'Open';
        right.appendChild(toggleBtn);

        header.appendChild(left);
        header.appendChild(right);
        item.appendChild(header);

        // body (collapsed by default)
        const body = document.createElement('div');
        body.className = 'result-body';
        // Show schedule excluding Passing Periods
        const todaysSchedule = schedules[doc.lunch || '1'] || [];
        // Build map of class names for the periods user provided (doc.classes)
        const classesMap = doc.classes || {};
        // Only show Period entries + LUNCH (no Passing Periods)
        todaysSchedule.forEach(p => {
          if (p.name === 'Passing Period') return; // skip
          const row = document.createElement('div');
          row.className = 'period';
          const leftText = (p.name.startsWith('Period') || p.name === 'LUNCH') ? p.name : p.name;
          let displayName = leftText;
          if (p.name.startsWith('Period')) {
            displayName = `${p.name} — ${classesMap[p.name] ?? '(No class)'}`;
          }
          const leftDiv = document.createElement('div');
          leftDiv.textContent = displayName;
          const rightDiv = document.createElement('div');
          rightDiv.textContent = `${p.start} - ${p.end}`;
          // highlight if current
          const now = new Date();
          const start = parseTime(p.start), end = parseTime(p.end);
          if (now >= start && now <= end && p.name !== 'Passing Period') {
            row.classList.add('highlight');
            leftDiv.style.fontWeight = '700';
          }
          row.appendChild(leftDiv);
          row.appendChild(rightDiv);
          body.appendChild(row);
        });

        // small status line
        const status = document.createElement('div');
        status.className = 'small';
        const now = new Date();
        const todaysSchedule2 = schedules[doc.lunch || '1'] || [];
        let currentEntry = null;
        for (const p of todaysSchedule2) {
          const start = parseTime(p.start), end = parseTime(p.end);
          if (now >= start && now <= end) { currentEntry = p; break; }
        }
        if (!currentEntry) status.textContent = 'No class in session right now';
        else if (currentEntry.name === 'LUNCH') status.textContent = 'It is currently LUNCH';
        else if (currentEntry.name === 'Passing Period') status.textContent = 'It is currently a Passing Period';
        else {
          const className = (doc.classes && doc.classes[currentEntry.name]) || '(No class)';
          status.textContent = `Current: ${currentEntry.name} — ${className}`;
        }
        body.appendChild(status);

        item.appendChild(body);
        resultList.appendChild(item);

        // Toggle logic
        header.addEventListener('click', () => {
          if (body.style.display === 'block') {
            body.style.display = 'none';
            toggleBtn.textContent = 'Open';
          } else {
            body.style.display = 'block';
            toggleBtn.textContent = 'Close';
          }
        });

      });

    } catch (err) {
      console.error('Search failed', err);
      resultList.innerHTML = `<div class="small" style="color:#f88">Search failed</div>`;
    }
  }

  // Escape HTML helper to avoid injection in case user typed weird text
  function escapeHtml(unsafe) {
    return String(unsafe)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  // clear search
  clearSearch.addEventListener('click', () => { searchInput.value=''; resultList.innerHTML=''; resultsCount.textContent='0'; });

  // debounce on typing
  searchInput.addEventListener('input', debounceSearch);
  searchBtn.addEventListener('click', doSearch);
  searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') doSearch(); });

  // Helper: open modal prefilled for editing a doc (only if owner)
  async function openEditorForDoc(docData) {
    const user = navAuth.currentUser;
    if (!user || user.uid !== docData.id) {
      alert('You can only edit your own schedule (login as owner).');
      return;
    }
    // prefill
    loggedEmailEl.textContent = user.email || 'Unknown';
    modalName.value = docData.displayName || '';
    modalLunch.value = docData.lunch || '1';
    renderPeriodInputs(modalLunch.value, docData.classes || {});
    addModal.style.display = 'flex';
  }

  // When clicking Edit in result list, we set up modal with doc info from DB just to be safe
  async function openEditorForDocById(docId) {
    try {
      const doc = await scheduleDb.collection('schedules').doc(docId).get();
      if (!doc.exists) { alert('Schedule not found'); return; }
      openEditorForDoc({ id: docId, ...doc.data() });
    } catch (err) {
      console.error('openEditor failed', err);
    }
  }

  /***************
   * SHOW LOGGED IN USER'S SCHEDULE (optional convenience)
   ***************/
  async function loadMySchedule(){
    const user = navAuth.currentUser;
    if (!user) { userScheduleBox.style.display='none'; return; }
    try {
      const doc = await scheduleDb.collection('schedules').doc(user.uid).get();
      if (!doc.exists) { userScheduleBox.style.display='none'; return; }
      const data = doc.data();
      userScheduleBox.style.display = 'block';
      userScheduleBox.innerHTML = `<strong style="display:block;color:var(--accent)">${escapeHtml(data.displayName)}</strong>
        <div class="small" style="margin-bottom:6px">Your lunch: ${data.lunch === '1' ? '1st Lunch' : '2nd Lunch'}</div>`;

      const todaysSchedule = schedules[data.lunch || '1']||[];
      for (const p of todaysSchedule) {
        if (p.name === 'Passing Period') continue; // hide passing periods
        const row = document.createElement('div');
        row.className = 'period';
        const left = document.createElement('div');
        if (p.name.startsWith('Period')) left.textContent = `${p.name} — ${data.classes?.[p.name] ?? '(No class)'}`;
        else left.textContent = p.name;
        const right = document.createElement('div'); right.textContent = `${p.start} - ${p.end}`;
        // highlight current
        const now = new Date(), start = parseTime(p.start), end = parseTime(p.end);
        if (now >= start && now <= end) {
          row.classList.add('highlight');
          left.style.fontWeight = '700';
        }
        row.appendChild(left); row.appendChild(right);
        userScheduleBox.appendChild(row);
      }
      // add an edit button
      const editBtn = document.createElement('button');
      editBtn.className = 'btn';
      editBtn.textContent = 'Edit My Schedule';
      editBtn.style.marginTop = '10px';
      editBtn.addEventListener('click', ()=>{
        // open modal prefilled
        modalName.value = data.displayName || '';
        modalLunch.value = data.lunch || '1';
        renderPeriodInputs(modalLunch.value, data.classes || {});
        addModal.style.display = 'flex';
      });
      userScheduleBox.appendChild(editBtn);
    } catch (err) {
      console.error('loadMySchedule failed', err);
    }
  }

  /***************
   * NAVBAR loader & auth state handling (keeps original navbar behavior)
   ***************/
  // Load navbar html
  fetch('/navbar.html')
    .then((res) => res.text())
    .then((html) => {
      document.getElementById('navbar-container').innerHTML = html;

      // After loading navbar, hook auth state
      navAuth.onAuthStateChanged((user) => {
        // Update navbar elements if present (keeps the structure from your navbar)
        const userStatus = document.getElementById('userStatus');
        const loginBtn = document.getElementById('loginBtn');
        const creditsBox = document.getElementById('creditsBox');
        const creditsAmount = document.getElementById('creditsAmount');

        if (user) {
          if (userStatus) userStatus.textContent = user.email || 'User';
          if (loginBtn) loginBtn.style.display = 'none';
          if (creditsBox) creditsBox.style.display = 'inline-flex';

          // show logged in email in modal
          loggedEmailEl.textContent = user.email || '(unknown)';

          // load current user's schedule into the user box
          loadMySchedule();

          // If navbar has user profile, you can also show edit option
          try {
            navDb.collection('users').doc(user.uid).onSnapshot((doc) => {
              if (doc.exists) {
                if (creditsAmount) creditsAmount.textContent = doc.data().credits ?? 0;
              } else {
                if (creditsAmount) creditsAmount.textContent = '0';
              }
            });
          } catch (err) {
            // ignore if navDb not accessible
            console.warn('navDb listener issue', err);
          }

        } else {
          if (userStatus) userStatus.textContent = 'Logged Out';
          if (loginBtn) loginBtn.style.display = 'inline-block';
          if (creditsBox) creditsBox.style.display = 'none';
          loggedEmailEl.textContent = 'Not logged in';
          userScheduleBox.style.display='none';
        }
      });
    })
    .catch((err) => console.error('Failed to load navbar:', err));

  /***************
   * Utilities & initial actions
   ***************/
  // allow clicking openAddBtn to redirect to login if navbar provides login button elsewhere
  // initial render for modal inputs based on selected lunch
  renderPeriodInputs(document.getElementById('modalLunch').value, {});

  // optional: show current user's schedule if already logged in
  navAuth.onAuthStateChanged((u) => { if (u) loadMySchedule(); else userScheduleBox.style.display='none'; });

  /***************
   * Developer Note (Security rules)
   * IMPORTANT: for true security, in the schedule project's Firestore rules set:
   *
   * rules_version = '2';
   * service cloud.firestore {
   *   match /databases/{database}/documents {
   *     match /schedules/{userId} {
   *       allow read: if true;
   *       allow write: if request.auth != null && request.auth.uid == userId;
   *     }
   *   }
   * }
   *
   * That will ensure only the authenticated owner (matching uid) may write their schedule.
   ***************/

  </script>
</body>
</html>
