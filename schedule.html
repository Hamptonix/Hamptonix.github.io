<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hamptonix | Schedule</title>
  <link rel="icon" type="image/png" href="https://i.postimg.cc/HnDd4JkX/channels4-profile-removebg-preview.png" />
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/style.css"/>

  <style>
    /* full theme & layout (kept & extended from your previous file) */
    :root{
      --accent: rgba(48,64,242,1);
      --glow: rgba(48,64,242,0.35);
      --muted: #9aa4b2;
    }
    html,body{height:100%;margin:0;font-family:Poppins,Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;}
    #navbar-container{position:relative;z-index:50;}
    .schedule-app{
      display:flex;justify-content:center;align-items:flex-start;min-height:100vh;
      background:linear-gradient(180deg,#020204 0%,#091014 100%);
      padding:30px 20px;box-sizing:border-box;color:#e6eef6;
    }
    .card{
      width:100%;max-width:900px;background:rgba(15,23,32,0.6);backdrop-filter:blur(14px);
      border-radius:16px;padding:20px;border:1px solid rgba(255,255,255,0.06);box-shadow:0 10px 40px rgba(0,0,0,0.6);
    }
    .header-row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0 0 8px 0;font-size:1.6rem}
    .controls{display:flex;gap:10px;align-items:center}
    select,input[type="text"]{
      padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.03);color:#fff;font-size:0.95rem;
    }
    .btn{padding:10px 14px;border-radius:12px;border:none;cursor:pointer;font-weight:600;background:linear-gradient(90deg,var(--accent),rgba(80,100,255,0.9));color:#fff;box-shadow:0 6px 18px var(--glow)}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.08);box-shadow:none;color:#e6eef6}
    .timers{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .timer{font-size:0.95rem;font-weight:600;background:rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;min-width:140px;text-align:center}
    .progress-wrapper{margin-top:10px;background:rgba(255,255,255,0.08);border-radius:12px;overflow:hidden;height:14px;box-shadow:inset 0 2px 6px rgba(0,0,0,0.6)}
    .progress-bar{height:100%;width:0%;background:var(--accent);box-shadow:0 0 12px var(--glow);transition:width 0.5s ease}
    /* Search container below timers */
    .search-container{margin-top:18px;background:rgba(255,255,255,0.02);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .search-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .result-list{margin-top:10px;display:flex;flex-direction:column;gap:8px}
    .result-item{background:rgba(255,255,255,0.02);border-radius:10px;padding:8px;border:1px solid rgba(255,255,255,0.03)}
    .result-header{display:flex;justify-content:space-between;align-items:center;cursor:pointer}
    .result-header .name{font-weight:700;color:#fff}
    .result-header .meta{color:var(--muted);font-size:0.95rem}
    .result-body{margin-top:8px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.03);display:none}
    .period{display:flex;justify-content:space-between;padding:6px 4px}
    .highlight{background:linear-gradient(90deg, rgba(48,64,242,0.08), rgba(48,64,242,0.04));border:1px solid rgba(48,64,242,0.12);border-radius:8px;padding:6px}
    .small{font-size:0.9rem;color:var(--muted)}
    .right-actions{display:flex;gap:8px;align-items:center}
    .inline-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px 8px;border-radius:8px;color:#fff;cursor:pointer}
    .inline-btn.ghost{color:var(--muted)}
    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:linear-gradient(180deg,rgba(1,2,3,0.6),rgba(1,2,3,0.85));display:none;align-items:center;justify-content:center;z-index:4000}
    .modal{width:100%;max-width:640px;background:rgba(12,16,24,0.98);border-radius:14px;padding:18px;border:1px solid rgba(255,255,255,0.06)}
    .modal h3{margin:0 0 8px;color:var(--accent)}
    .form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .form-grid .full{grid-column:1/-1}
    @media (max-width:720px){
      .form-grid{grid-template-columns:1fr}
      .timers{justify-content:stretch}
    }
  </style>
</head>
<body>
  <div id="navbar-container"></div>

  <div class="schedule-app">
    <div class="card">
      <div class="header-row">
        <div>
          <h1>Odyssey Schedule Tracker</h1>
          <div class="small">Select lunch to update the timer & schedule view</div>
        </div>
        <div class="controls">
          <label for="lunch" class="small" style="margin-right:8px; align-self:center;">Lunch:</label>
          <select id="lunch">
            <option value="1">Lunch 1</option>
            <option value="2">Lunch 2</option>
          </select>
          <button id="openAddBtn" class="btn" title="Add / edit your schedule">Add / Edit Your Schedule</button>
        </div>
      </div>

      <div style="margin-top:10px">
        <h2 id="currentPeriod">Loading...</h2>
        <div class="progress-wrapper"><div id="progressBar" class="progress-bar"></div></div>

        <div class="timers">
          <div class="timer" id="elapsed">Elapsed: --</div>
          <div class="timer" id="remaining">Remaining: --</div>
          <div class="timer" id="endOfDay">Until End of Day: --</div>
          <div class="timer" id="weekendTimer">Until Weekend: --</div>
        </div>
      </div>

      <!-- SEARCH CONTAINER (below timers) -->
      <div class="search-container" id="searchContainer">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <div style="flex:1">
            <input id="searchInput" type="text" placeholder="Search name..." style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff" />
          </div>
          <div style="display:flex;gap:8px">
            <button id="searchBtn" class="btn ghost">Search</button>
            <button id="clearSearch" class="inline-btn ghost">Clear</button>
          </div>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <div class="small">Results: <span id="resultsCount">0</span></div>
          <div class="small">Tip: type a first or last name (prefix search)</div>
        </div>

        <div class="result-list" id="resultList" style="margin-top:10px"></div>
      </div>

      <!-- user schedule box (hidden by default when not used) -->
      <div id="userScheduleBox" class="user-schedule" style="display:none;margin-top:12px"></div>

    </div>
  </div>

  <!-- Modal -->
  <div id="addModal" class="modal-backdrop">
    <div class="modal">
      <h3>Add / Edit Your Schedule</h3>
      <div style="margin-bottom:10px" class="small">You must be logged in to save. Logged in as: <strong id="loggedEmail">Not logged in</strong></div>

      <div style="margin-bottom:10px">
        <label style="display:block;margin-bottom:6px">Display name (shown in search results)</label>
        <input id="modalName" type="text" placeholder="e.g. Eli Hampton" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff">
      </div>

      <div style="margin-bottom:10px">
        <label style="display:block;margin-bottom:6px">Lunch</label>
        <select id="modalLunch" style="width:100%;padding:10px;border-radius:8px">
          <option value="1">1st Lunch</option>
          <option value="2">2nd Lunch</option>
        </select>
      </div>

      <div id="periodInputs" style="margin-bottom:8px"></div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button id="cancelModal" class="btn ghost">Cancel</button>
        <button id="saveSchedule" class="btn">Save Schedule</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
/***************
 * SCHEDULE + TIMER LOGIC
 ***************/
const schedulesBase = {
  1: [
    {name:"Period 1", start:"07:40", end:"08:45"},
    {name:"Period 2", start:"08:47", end:"09:52"},
    {name:"Period 3", start:"09:54", end:"10:59"},
    {name:"LUNCH",    start:"11:01", end:"11:21"},
    {name:"Period 5", start:"11:23", end:"12:28"},
    {name:"Period 6", start:"12:30", end:"13:35"},
    {name:"Period 7", start:"13:37", end:"14:42"},
    {name:"Period 8", start:"14:44", end:"15:49"},
  ],
  2: [
    {name:"Period 1", start:"07:40", end:"08:45"},
    {name:"Period 2", start:"08:47", end:"09:52"},
    {name:"Period 3", start:"09:54", end:"10:59"},
    {name:"Period 4", start:"11:01", end:"12:06"},
    {name:"LUNCH",    start:"12:08", end:"12:28"},
    {name:"Period 6", start:"12:30", end:"13:35"},
    {name:"Period 7", start:"13:37", end:"14:42"},
    {name:"Period 8", start:"14:44", end:"15:49"},
  ]
};

function parseTime(timeStr){
  const [h,m] = timeStr.split(":").map(Number);
  const d = new Date();
  d.setHours(h, m, 0, 0);
  return d;
}

function addMinutes(timeStr, mins){
  const d = parseTime(timeStr);
  d.setMinutes(d.getMinutes() + mins);
  return d;
}

function withPassingPeriods(schedule){
  const result = [];
  for(let i=0;i<schedule.length;i++){
    result.push(schedule[i]);
    if(i<schedule.length-1){
      result.push({name:"Passing Period", start:schedule[i].end, end:addMinutes(schedule[i].end,2)});
    }
  }
  return result;
}

const schedules = {
  1: withPassingPeriods(schedulesBase[1]),
  2: withPassingPeriods(schedulesBase[2])
};

function formatDuration(ms){
  if(ms < 0) ms = 0;
  const totalSeconds = Math.floor(ms/1000);
  const h = Math.floor(totalSeconds/3600);
  const m = Math.floor((totalSeconds%3600)/60);
  const s = totalSeconds%60;
  return `${h}h ${m}m ${s}s`;
}

function nextWeekendStart(now){
  const d = new Date(now);
  const day = d.getDay();
  const daysUntilFriday = (5-day+7)%7;
  d.setDate(d.getDate()+daysUntilFriday);
  d.setHours(0,0,0,0);
  return d;
}

function nextSchoolStart(now){
  const d = new Date(now);
  const day = d.getDay();
  let addDays = 0;
  if(day===5) addDays=3;
  else if(day===6) addDays=2;
  else if(day===0) addDays=1;
  else addDays=1;
  d.setDate(d.getDate()+addDays);
  d.setHours(7,40,0,0);
  return d;
}

function updateSchedule(){
  const lunchChoice = document.getElementById("lunch").value;
  const now = new Date();
  const day = now.getDay();

  const display = document.getElementById("currentPeriod");
  const elapsedEl = document.getElementById("elapsed");
  const remainingEl = document.getElementById("remaining");
  const progressBar = document.getElementById("progressBar");
  const endOfDayEl = document.getElementById("endOfDay");
  const weekendEl = document.getElementById("weekendTimer");

  if(day===5||day===6||day===0){
    display.textContent="It's the weekend 🎉";
    elapsedEl.textContent="Elapsed: --";
    remainingEl.textContent="Remaining: --";
    progressBar.style.width="0%";
    endOfDayEl.textContent="Until School Starts: "+formatDuration(nextSchoolStart(now)-now);
    weekendEl.textContent="Weekend: NOW";
    return;
  }

  const todaysSchedule = schedules[lunchChoice];
  let current = null;
  for(const p of todaysSchedule){
    const start = parseTime(p.start);
    const end = parseTime(p.end);
    if(now >= start && now <= end){ current = {...p, start, end}; break; }
  }

  if(current){
    display.textContent=`Current: ${current.name}`;
    const elapsedMs = now - current.start;
    const remainingMs = current.end - now;
    const totalMs = current.end - current.start;
    elapsedEl.textContent=`Elapsed: ${formatDuration(elapsedMs)}`;
    remainingEl.textContent=`Remaining: ${formatDuration(remainingMs)}`;
    progressBar.style.width=`${Math.max(0, Math.min(100, (elapsedMs/totalMs)*100))}%`;
  } else {
    display.textContent="No class in session";
    elapsedEl.textContent="Elapsed: --";
    remainingEl.textContent="Remaining: --";
    progressBar.style.width="0%";
  }

  const lastEnd = parseTime(todaysSchedule[todaysSchedule.length-1].end);
  if(now < lastEnd) endOfDayEl.textContent="Until End of Day: "+formatDuration(lastEnd-now);
  else endOfDayEl.textContent="Until School Starts: "+formatDuration(nextSchoolStart(now)-now);

  const weekendStart = nextWeekendStart(now);
  weekendEl.textContent = now >= weekendStart ? "Weekend: NOW" : "Until Weekend: "+formatDuration(weekendStart-now);
}
setInterval(updateSchedule,1000); updateSchedule();

/***************
 * FIREBASE SETUP
 ***************/
const firebaseNavConfig = {
  apiKey: "AIzaSyCxscgTATE4IUgB7pGX01lP3Wr8pdU1B_8",
  authDomain: "hamptonixwebsite-dea39.firebaseapp.com",
  projectId: "hamptonixwebsite-dea39",
  storageBucket: "hamptonixwebsite-dea39.appspot.com",
  messagingSenderId: "847673046697",
  appId: "1:847673046697:web:99d1de90522f1545cd5bb8",
  measurementId: "G-CBL1NL69PH"
};
const navApp = firebase.initializeApp(firebaseNavConfig, "navApp");
const navAuth = navApp.auth();
const navDb = navApp.firestore();

const firebaseScheduleConfig = {
  apiKey: "AIzaSyC5fRmcLfedV0C_KQI7xgiLxe9QSFJ9Nqg",
  authDomain: "school-schedule-tracker-dd433.firebaseapp.com",
  projectId: "school-schedule-tracker-dd433",
  storageBucket: "school-schedule-tracker-dd433.firebasestorage.app",
  messagingSenderId: "424273851516",
  appId: "1:424273851516:web:fcd136728acaee29a0c5f9",
  measurementId: "G-36S4Q1GB3G"
};
const scheduleApp = firebase.initializeApp(firebaseScheduleConfig, "scheduleApp");
const scheduleDb = scheduleApp.firestore();

/***************
 * MODAL + SCHEDULE EDIT LOGIC
 ***************/
const openAddBtn = document.getElementById('openAddBtn');
const addModal = document.getElementById('addModal');
const cancelModal = document.getElementById('cancelModal');
const saveScheduleBtn = document.getElementById('saveSchedule');
const modalName = document.getElementById('modalName');
const modalLunch = document.getElementById('modalLunch');
const periodInputs = document.getElementById('periodInputs');
const loggedEmailEl = document.getElementById('loggedEmail');

function getInputPeriodsForLunch(lunch){
  return lunch==='1'
    ? ["Period 1","Period 2","Period 3","Period 5","Period 6","Period 7","Period 8"]
    : ["Period 1","Period 2","Period 3","Period 4","Period 6","Period 7","Period 8"];
}

function renderPeriodInputs(lunch, classesObj={}){
  const periods = getInputPeriodsForLunch(String(lunch));
  periodInputs.innerHTML = '';
  const info = document.createElement('div');
  info.className = 'small';
  info.style.marginBottom='8px';
  info.textContent = `Fill the 7 class boxes that match ${lunch==='1'?'1st Lunch':'2nd Lunch'}.`;
  periodInputs.appendChild(info);

  const grid = document.createElement('div');
  grid.className='form-grid';
  periods.forEach(name=>{
    const wrapper = document.createElement('div');
    const label = document.createElement('label');
    label.textContent = name;
    label.style.display='block';
    label.style.color='var(--muted)';
    label.style.marginBottom='6px';
    const input = document.createElement('input');
    input.type='text';
    input.value=classesObj[name]??'';
    input.placeholder=`Enter class for ${name}`;
    input.dataset.period=name;
    input.style.width='100%';
    input.style.padding='8px';
    input.style.borderRadius='8px';
    input.style.border='1px solid rgba(255,255,255,0.06)';
    input.style.background='transparent';
    input.style.color='#fff';
    wrapper.appendChild(label);
    wrapper.appendChild(input);
    grid.appendChild(wrapper);
  });
  periodInputs.appendChild(grid);
}

// Open modal
openAddBtn.addEventListener('click', async ()=>{
  const user = navAuth.currentUser;
  if(!user){ alert('You must be logged in to add or edit your schedule.'); return; }
  loggedEmailEl.textContent = user.email||'Unknown';

  try{
    const docRef = scheduleDb.collection('schedules').doc(user.uid);
    const doc = await docRef.get();
    if(doc.exists){
      const data = doc.data();
      modalName.value = data.displayName ?? user.displayName ?? user.email.split('@')[0];
      modalLunch.value = data.lunch ?? '1';
      renderPeriodInputs(modalLunch.value, data.classes || {});
    } else {
      modalName.value = user.displayName ?? user.email.split('@')[0];
      modalLunch.value = document.getElementById('lunch').value ?? '1';
      renderPeriodInputs(modalLunch.value, {});
    }
  } catch(err){
    console.error('Failed to prefill modal', err);
    modalName.value = user.displayName ?? user.email.split('@')[0];
    modalLunch.value = document.getElementById('lunch').value ?? '1';
    renderPeriodInputs(modalLunch.value, {});
  }
  addModal.style.display='flex';
});

cancelModal.addEventListener('click', ()=> addModal.style.display='none');
modalLunch.addEventListener('change', ()=> renderPeriodInputs(modalLunch.value));

// Save schedule
saveScheduleBtn.addEventListener('click', async ()=>{
  const user = navAuth.currentUser;
  if(!user){ alert('You must be logged in to save your schedule.'); return; }
  const name = modalName.value.trim();
  if(name.length<2){ alert('Please provide a display name (2+ characters).'); return; }

  const lunch = modalLunch.value;
  const inputs = periodInputs.querySelectorAll('input[data-period]');
  const classes = {};
  let allFilled = true;
  inputs.forEach(inp=>{
    const val = inp.value.trim();
    if(!val) allFilled=false;
    classes[inp.dataset.period]=val;
  });
  if(!allFilled){ alert('Please fill all class boxes.'); return; }

  try{
    await scheduleDb.collection('schedules').doc(user.uid).set({
      displayName: name,
      lunch,
      classes
    });
    addModal.style.display='none';
    alert('Schedule saved successfully!');
  } catch(err){
    console.error('Failed to save schedule',err);
    alert('Failed to save schedule, try again.');
  }
});

/***************
 * AUTH STATE
 ***************/
navAuth.onAuthStateChanged(user=>{
  const loginEl = document.getElementById('loginStatus');
  if(user){
    loginEl.textContent = `Logged in as ${user.email}`;
  } else {
    loginEl.textContent = 'Not logged in';
  }
});
</script>

</body>
</html>
